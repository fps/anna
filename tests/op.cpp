#include <gtest/gtest.h>
#include <scratch/op.hpp>

using namespace anna::op;

TEST(anna, conv1d) 
{
  Eigen::Matrix<float, 3, 3> m1;
  m1 << 
       1.360321070972355,     -0.5320392044369056,       1.412908992764535,
     -0.5484870195677554,       1.235250891448293,     -0.1993897326223285,
    -0.01622366300148917,     0.02983153223088251,      0.1456017614433357
  ;

  Eigen::Matrix<float, 3, 3> m2;
  m2 << 
      0.8973694008950653,     -0.9854839910989702,      -1.846855019319682, 
     -0.6944077802207077,     -0.3956387688860474,      -1.143050377330966, 
      0.1463197229062805,       -1.56581951249452,      -1.085485355579867 
  ;

  Eigen::Matrix<float, 3, 8> input;
  input << 
      0.4707138569661863,      0.7432803320176871,     -0.9726576921284368,     -0.5064305440515976,      0.3268022241354597,      0.5186173590272831,      0.8389459817935416,     -0.2168599069704246, 
     0.05236336494302119,      0.5225674449539569,       1.144326968850749,        1.25821613496415,     -0.4761607270732892,      -1.549853255205629,      -2.399221086152557,     -0.4579552848761627, 
      -1.136690524091938,      0.7137470949799795,      0.4629522367667219,     -0.6773683109266859,     -0.1529755493225306,     -0.8137783581594135,      0.8571475355861619,       1.736456582939496
  ;

  Eigen::Matrix<float, 3, 8> true_output;
  true_output <<
     -0.6073898004169673,       1.270226294049748,      -3.191168315572579,      -3.918595298934796,       1.235696629148085,        2.66809264237309,       6.725708674294277,       2.488832829360266, 
      0.8729574305294491,      -1.369945358053462,     0.01944156822729588,      0.8900241282237212,    0.004779939887239446,      0.7396168976860976,      -1.142942784496882,       -1.63171348642478, 
    -0.01103422207679582,    -0.01136708803045088,      -3.218472997673505,      -3.361426595748056,       1.269729776252241,         3.4326098346083,        6.11660460478117,       1.329699347888651
  ;

  linear1<float, 3, 8,
  linear1<float, 3, 8,
  output<float, 3, 8
  >>> net;

  net.set<0>(m1);
  net.set<1>(m2);

  process(net, input, 8);

  EXPECT_TRUE(net.end().m_input.isApprox(true_output));
}

